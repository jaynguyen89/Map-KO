<style type="text/css">
    .microBtn {
        padding: 3px !important;
        font-size: 10px !important;
        border-radius: 3px !important;
        margin-top: 2px !important;
    }

    .myTable {
        margin-top: 0px !important;
    }

    .myMap {
        margin-bottom: 20px;
    }

    .setView {
        margin-bottom: 20px;
    }

    #outerDiv {
        position: relative;
    }

    #view_people {
        position: absolute;
        top: 60px;
        left: 30px;
        width: 260px;
    }

    #editPeople {
        width: 100%;
        margin-bottom: 20px;
    }

    .clearfix { clear: both; }
</style>

<div class="row mainContent">
    <div class="row setView">
        <div class="ui two column centered grid">
            <div class="column">
                <span><b>Select a view mode:</b>&nbsp;</span>
                <select name="View" class="ui dropdown"
                        data-bind="options: VIEWS, value: SelectedView, valueUpdate: 'afterkeydown', event: { change: $root.switchView }">
                </select>
            </div>
        </div>
    </div>

    <div class="ui right labeled input">
        <input type="text" placeholder="Search a person ...">
        <div class="ui dropdown label">
            <div class="text">By Name</div>
            <i class="dropdown icon"></i>
            <div class="menu">
                <div class="item">By Name</div>
                <div class="item">By Email</div>
            </div>
        </div>
    </div>
    
    <div id="outerDiv">
        <div id="main_map" class="ui embed myMap"></div>
        <div class="clearfix"></div>
        <div id="view_people" data-bind="visible: $root.ShouldShowMarkerContent">
            <div class="ui card" data-bind="with: $root.SelectedMarker">
                <div class="content">
                    <div class="header" style="font-size: 16px;" data-bind="text: '#' + Id + '&nbsp;|&nbsp;' + $root.FullNames()[Id - 1]"></div>
                    <div class="meta" style="font-size: 12px;" data-bind="text: Email"></div>
                    <div class="meta" style="font-size: 12px;" 
                         data-bind="text: Phone() + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + $root.Births()[Id - 1]"></div>
                    <div class="description">
                        <i class="fas fa-map-marked-alt"></i>&nbsp;
                        <span style="font-size: 13px;" data-bind="text: $root.NormalizedAddresses()[Id - 1]"></span>
                    </div>
                    <div class="row">
                        <button class="microBtn ui blue button">Select</button>
                        <button class="microBtn ui red button right floated" data-bind="click: $root.deletePeopleOnMap.bind(this, Id)">Delete</button>
                        <button class="microBtn ui orange button right floated" data-bind="click: $root.editPeopleOnMap.bind(this, Id)">Edit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editPeople" class="ui blue card" data-bind="visible: ShouldShowEditPeople">
        <div class="content">
            <div class="header">Edit People</div>
            <div class="description">Please note: the fields with asterisk (*) are required.</div>
        </div>
        <div class="extra content">
            <div class="ui stackable grid">
                <div class="six wide column">
                    <div id="address_map" class="ui embed" style="height: 100%;"></div>
                </div>
                <div class="ten wide column">
                    <form class="ui form" data-bind="with: SelectedPeople">
                        <p id="editPeopleError">This is an error.</p>
                        <div class="ui stackable grid">
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="FamilyName">Family Name*</label>
                                    <input type="text" name="FamilyName" id="FamilyName" data-bind="value: FamilyName" placeholder="Ex. Potter" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="GiveName">Give Name*</label>
                                    <input type="text" name="GiveName" id="GiveName" data-bind="value: GiveName" placeholder="Ex. Harry" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="Email">Email</label>
                                    <input type="email" name="Email" id="Email" data-bind="value: Email" placeholder="Ex. some.thing_else123@domain.com.ex" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="Phone">Phone</label>
                                    <input type="text" name="Phone" id="Phone" data-bind="value: Phone" placeholder="Ex: 0412 345 678" />
                                </div>
                            </div>
                            <div class="sixteen wide column">
                                <div class="sixteen wide column"><span style="color: black;">Birthday</span></div>
                                <div class="ui stackable grid">
                                    <div class="five wide column">
                                        <label for="Birthday">Day</label>
                                        <input type="number" min="1" max="31" name="Birthday" id="Birthday" data-bind="value: Birthday()" />
                                    </div>
                                    <div class="five wide column">
                                        <label for="Birthmonth">Month</label>
                                        <input type="number" min="1" max="12" name="Birthmonth" id="Birthmonth" data-bind="value: Birthmonth()" />
                                    </div>
                                    <div class="five wide column">
                                        <label for="Birthyear">Year</label>
                                        <input type="number" min="0" name="Birthyear" id="Birthyear" data-bind="value: Birthyear()" />
                                    </div>
                                    <div class="one wide column">
                                        <label for="BC">BC</label>
                                        <input type="checkbox" name="BC" value="1" id="BC" data-bind="checked: BirthBC" />
                                    </div>
                                </div>
                            </div>
                            <div class="sixteen wide column"><b style="color: black;">People Home Address</b></div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="BuildingAddress">Building Address</label>
                                    <input type="text" name="BuildingAddress" id="BuildingAddress" data-bind="value: BuildingAddress" placeholder="Ex: Building 1, Fl4.120" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="StreetAddress">Street Address*</label>
                                    <input type="text" name="StreetAddress" id="StreetAddress" data-bind="value: StreetAddress, event: { change: $root.relocatePeople }" placeholder="Ex: 12 Somewhere Street" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="AlternateAddress">Alternate Address</label>
                                    <input type="text" name="AlternateAddress" id="AlternateAddress" data-bind="value: AlternateAddress" placeholder="optional" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="Suburb">Suburb*</label>
                                    <input type="text" name="Suburb" id="Suburb" data-bind="value: Suburb, event: { change: $root.relocatePeople }" placeholder="Ex: Sunshine" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="Postcode">Postcode*</label>
                                    <input type="text" name="Postcode" id="Postcode" data-bind="value: Postcode, event: { change: $root.relocatePeople }" placeholder="Ex: 3020" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="State">State*</label>
                                    <Select type="text" name="State" id="State" data-bind="options: $root.STATES, value: State, event: { change: $root.relocatePeople }" />
                                </div>
                            </div>
                            <input type="text" name="Lat" id="Lat" data-bind="value: Lat" hidden />
                            <input type="text" name="Long" id="Long" data-bind="value: Long" hidden />
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="extra content">
            <button class="ui green button" data-bind="click: $root.detectLocation"><i class="fas fa-map-marker-alt"></i> Auto Detect</button>
            <div class="right floated">
                <button class="ui black button" data-bind="click: $root.cancelEdit"><i class="fas fa-undo"></i> Cancel</button>
                <button class="ui blue button" data-bind="click: $root.editPeopleConfirmed"><i class="fas fa-check"></i> Done</button>
            </div>
        </div>
    </div>

    <table id="main_table" class="myTable ui compact celled definition blue table" data-bind="with: $root.People">
        <thead class="full-width">
            <tr>
                <th class="center aligned"><i class="fas fa-hand-point-up"></i></th>
                <th class="center aligned"><i class="fas fa-hashtag"></i></th>
                <th class="center aligned"><i class="fas fa-signature"></i> Name</th>
                <th class="center aligned"><i class="fas fa-envelope"></i> Email</th>
                <th class="center aligned"><i class="fas fa-phone"></i> Phone</th>
                <th class="center aligned"><i class="fas fa-birthday-cake"></i> Birthday</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: $root.People">
            <tr data-bind="visible: IsActive">
                <td class="collapsing">
                    <div class="ui fitted slider checkbox">
                        <input id="" type="checkbox"><label></label>
                    </div>
                </td>
                <th data-bind="text: Id"></th>
                <th>
                    <div class="ui stackable two column grid">
                        <div class="column">
                            <span data-bind="text: $root.FullNames()[Id - 1]"></span>
                        </div>
                        <div class="column">
                            <button class="microBtn ui red button right floated" data-bind="click: $root.deletePeople">Delete</button>
                            <button class="microBtn ui orange button right floated" data-bind="click: $root.editPeopleOnTable">Edit</button>
                            <button class="microBtn ui blue button right floated">Details</button>
                        </div>
                    </div>
                </th>
                <th data-bind="text: Email"></th>
                <th data-bind="text: Phone"></th>
                <th data-bind="text: $root.Births()[Id - 1]"></th>
            </tr>
        </tbody>
        <tfoot class="full-width">
            <tr>
                <th></th>
                <th colspan="5">
                    <div class="ui right floated small red icon button">
                        <i class="fas fa-reply"></i> Revert to Default
                    </div>
                    <div class="ui right floated small primary icon button">
                        <i class="fas fa-user-plus"></i> Add People
                    </div>
                    <div class="ui left floated small green icon button">
                        <i class="fas fa-route"></i> Distance
                    </div>
                </th>
            </tr>
        </tfoot>
    </table>
</div>

<script type="text/javascript">
    var infowindow = new google.maps.InfoWindow();
    var marker;

    var errorDiv = document.getElementById("editPeopleError");

    var data = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "files/model.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })();

    function PeopleModel(people) {
        var self = this;
        self.Id = people.Id;
        self.FamilyName = people.FamilyName ? ko.observable(people.FamilyName) : ko.observable("");
        self.GiveName = people.GiveName ? ko.observable(people.GiveName) : ko.observable("");
        self.Email = people.Email ? ko.observable(people.Email) : ko.observable("Email not given.");
        self.Phone = people.Phone ? ko.observable(people.Phone) : ko.observable("---");
        self.Birthday = people.Birthday ? ko.observable(people.Birthday) : ko.observable("--");
        self.Birthmonth = people.Birthmonth ? ko.observable(people.Birthmonth) : ko.observable("--");
        self.Birthyear = people.Birthyear ? ko.observable(people.Birthyear) : ko.observable("--");
        self.BirthBC = ko.observable(people.BirthBC);
        self.BuildingAddress = people.BuildingAddress ? ko.observable(people.BuildingAddress) : ko.observable("");
        self.StreetAddress = people.StreetAddress ? ko.observable(people.StreetAddress) : ko.observable("");
        self.AlternateAddress = people.AlternateAddress ? ko.observable(people.AlternateAddress) : ko.observable("");
        self.Suburb = people.Suburb ? ko.observable(people.Suburb) : ko.observable("");
        self.Postcode = people.Postcode ? ko.observable(people.Postcode) : ko.observable("");
        self.State = people.State ? ko.observable(people.State) : ko.observable("");
        self.Lat = people.Lat ? ko.observable(people.Lat) : ko.observable("");
        self.Long = people.Long ? ko.observable(people.Long) : ko.observable("");
        self.IsActive = ko.observable(people.IsActive);
        self.IsChosen = ko.observable(false);
    }

    function ViewModel() {
        var self = this;
        self.STATES = ["ACT", "NSW", "NT", "QLD", "SA", "TAS", "VIC", "WA"];
        self.VIEWS = ["Both Views", "Map View", "Table View"];
        self.SelectedView = ko.observable("Both Views");
        self.ShouldShowMarkerContent = ko.observable(false);
        self.SelectedMarker = ko.observable();
        self.ShouldShowEditPeople = ko.observable(false);
        self.SelectedPeople = ko.observable();
        self.TempPeople = null;
        
        self.switchView = function () {
            if (self.SelectedView() === "Map View") {
                $("#main_map").show("slow");
                $("#main_table").hide("slow");
                if (self.SelectedMarker() != undefined)
                    self.ShouldShowMarkerContent(true);
            }

            if (self.SelectedView() === "Table View") {
                $("#main_map").hide("slow");
                $("#main_table").show("slow");
                self.ShouldShowMarkerContent(false);
            }
            
            if (self.SelectedView() === "Both Views") {
                $("#main_map").show("slow");
                $("#main_table").show("slow");
                if (self.SelectedMarker() != undefined)
                    self.ShouldShowMarkerContent(true);
            }
            
            self.ShouldShowEditPeople(true);
            self.SelectedPeople(null);
        }

        self.People = ko.observableArray();
        for (var k in data) {
            var people = new PeopleModel(ko.toJS(data[k]));
            self.People.push(people);
        }

        self.FullNames = ko.computed(function () {
            var fullNames = [];
            ko.utils.arrayForEach(self.People(), function (p) {
                let fullName = p.GiveName() + " " + p.FamilyName();
                fullNames.push(fullName);
            });
            
            return fullNames;
        }, self);

        self.NormalizedAddresses = ko.computed(function () {
            var normalizedAddresses = [];
            ko.utils.arrayForEach(self.People(), function (p) {
                let building = (p.BuildingAddress().length === 0 ? "" : p.BuildingAddress() + ", "); 
                let street = (p.StreetAddress().length === 0 ? "" : p.StreetAddress() + ", "); 
                let suburb = (p.Suburb().length === 0 ? "" : p.Suburb() + ", ");

                let normalizedAddress = "";
                if (!building && !street && !suburb)
                    normalizedAddress = "Address not available.";
                else
                    normalizedAddress = building + street + suburb + p.State() + " " + p.Postcode();

                normalizedAddresses.push(normalizedAddress);
            });

            return normalizedAddresses;
        }, self);

        self.Births = ko.computed(function () {
            var births = [];
            ko.utils.arrayForEach(self.People(), function (p) {
                let birth = p.Birthday() + "/" + p.Birthmonth() + "/" + p.Birthyear() + (p.BirthBC() ? " BC" : "");
                births.push(birth);
            });

            return births;
        }, self);

        self.locations = ko.computed(function () {
            var locs = [];
            ko.utils.arrayForEach(self.People(), function (p) {
                if (p.IsActive()) {
                    var loc = [p.Id, self.FullNames()[p.Id - 1], p.Email, p.Phone, self.Births()[p.Id - 1], parseFloat(p.Lat()), parseFloat(p.Long())];
                    locs.push(loc);
                }
            });

            return locs;
        }, self);
        
        self.getMarkerState = function (marker) {
            self.SelectedMarker(self.People()[marker.title - 1]);
            self.ShouldShowMarkerContent(true);
        }

        renderMap(self.locations, self.getMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);

        self.cancelEdit = function () {
            self.SelectedPeople(null);
            self.ShouldShowEditPeople(false);
        }
        
        self.editPeopleOnTable = function (people) {
            self.TempPeople = people;
            self.SelectedPeople(new PeopleModel(ko.toJS(people)));
            renderAddressMap(parseFloat(self.TempPeople.Lat()), parseFloat(self.TempPeople.Long()));
            self.ShouldShowEditPeople(true);
        }

        self.editPeopleOnMap = function (peopleId) {
            if (self.SelectedPeople() != undefined) {
                if (confirm("Discard all changes with current editted people?")) {
                    self.TempPeople = self.People()[peopleId - 1];
                    self.SelectedPeople(new PeopleModel(ko.toJS(self.TempPeople)));
                    renderAddressMap(parseFloat(self.TempPeople.Lat()), parseFloat(self.TempPeople.Long()));
                }
            }
            else {
                self.TempPeople = self.People()[peopleId - 1];
                self.SelectedPeople(new PeopleModel(ko.toJS(self.TempPeople)));
                renderAddressMap(parseFloat(self.TempPeople.Lat()), parseFloat(self.TempPeople.Long()));
            }

            self.ShouldShowEditPeople(true);
        }

        self.editPeopleConfirmed = function () {
            let edittedPeople = new PeopleModel(ko.toJS(self.SelectedPeople));
            self.People.replace(self.TempPeople, edittedPeople);
            
            renderMap(self.locations, self.getMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
            self.ShouldShowMarkerContent(false);
            self.SelectedMarker(null);
            
            self.ShouldShowEditPeople(false);
            alert("New changes have been saved to people #" + edittedPeople.Id + " | " + self.FullNames()[edittedPeople.Id - 1]);
        }

        self.detectLocation = function () {
            if (confirm("Map-KO needs to access your device\'s location service.")) {
                if (navigator.geolocation) {
                    errorDiv.style.display = "none";
                    navigator.geolocation.getCurrentPosition(processPosition, navigatorError);
                }
                else
                    displayError("Oops! A problem occurred while detecting your location.");
            }
            else
                displayError("Oops! You didn\'t grant permission for location access.");
        }
        
        self.deletePeople = function (people) {
            if (confirm("Are you sure to delete #" + peopleId + ": " + self.People()[peopleId - 1].FullName() + "?")) {
                var temp = new PeopleModel(ko.toJS(people));
                people.IsActive(false);
                self.People.replace(temp, people);
                self.ShouldShowMarkerContent(false);
                renderMap(self.locations, self.getMarkerState, self.ShouldShowMarkerContent);
            }
        }

        self.deletePeopleOnMap = function (peopleId) {
            if (confirm("Are you sure to delete #" + peopleId + ": " + self.People()[peopleId - 1].FullName() + "?")) { 
                self.People()[peopleId - 1].IsActive(false);
                self.ShouldShowMarkerContent(false);
                renderMap(self.locations, self.getMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
            }
        }

        self.relocatePeople = function () {
            let edittedPeople = new PeopleModel(ko.toJS(self.SelectedPeople));
            let building = (edittedPeople.BuildingAddress().length === 0 ? "" : edittedPeople.BuildingAddress() + ", "); 
            let street = (edittedPeople.StreetAddress().length === 0 ? "" : edittedPeople.StreetAddress() + ", "); 
            let suburb = (edittedPeople.Suburb().length === 0 ? "" : edittedPeople.Suburb() + ", ");

            let normalizedAddress = building + street + suburb + edittedPeople.State() + " " + edittedPeople.Postcode();
            updateLocation(normalizedAddress);
        }
    }

    var ViewModel = new ViewModel();

    function renderMap(locations, getMarkerState, ShouldShowMarkerContent, SelectedMarker) {
        var map = new google.maps.Map(document.getElementById('main_map'), {
            zoom: 4.5,
            center: new google.maps.LatLng(-25.656515, 133.245630),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        for (var i = 0; i < locations().length; i++) {
            if (locations()[i][5] === 0 || locations()[i][6] === 0)
                continue;
            
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(locations()[i][5], locations()[i][6]),
                title: locations()[i][0],
                map: map
            });

            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    infowindow.setContent(locations()[i][1]);
                    infowindow.open(map, marker);
                    getMarkerState(this);
                }
            })(marker, i));

            google.maps.event.addListener(infowindow, 'closeclick', function () {
                ShouldShowMarkerContent(false);
                SelectedMarker("");
            });
        }
    }

    var addressMap;
    var addressMarker;
    function renderAddressMap(latitude, longitude) {
        addressMap = new google.maps.Map(document.getElementById('address_map'), {
            zoom: 16,
            center: new google.maps.LatLng(latitude, longitude),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        addressMarker = new google.maps.Marker({
            position: { lat: latitude, lng: longitude }
        });

        addressMarker.setMap(addressMap);
    }

    function processPosition(position) {
        displayLocation(position.coords.latitude, position.coords.longitude);

        $("#Lat").val(position.coords.latitude).change(); 
        $("#Long").val(position.coords.longitude).change();

        let requestURL = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + position.coords.latitude + "," + position.coords.longitude + "&key=AIzaSyDeataTmSWECGMeGzuh5-RbAadj_rMqbgI";
        $.getJSON(requestURL, function (data) {
            if (data["status"] == "OK") {
                $("#StreetAddress").val(data["results"][0]["address_components"][0]["short_name"] + " " + data["results"][0]["address_components"][1]["short_name"]).change();
                $("#Suburb").val(data["results"][0]["address_components"][2]["short_name"]).change();
                $("#Postcode").val(data["results"][0]["address_components"][6]["short_name"]).change();
                $("#State").val(data["results"][0]["address_components"][4]["short_name"]).change();
            }
            else
                errorDiv.innerHTML = "Error ocurred while detecting address. Please try again.";
        });
    }

    function displayLocation(lat, long) { 
        var map = new google.maps.Map(document.getElementById('address_map'), {
            zoom: 16,
            center: new google.maps.LatLng(lat, long),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat, long),
            label: { text: "Your Location.", fontWeight: "bold", color: "#FF1493" },
            icon: {
                labelOrigin: new google.maps.Point(1, 5),
                path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                scale: 5
            },
            map: map
        });
    }

    function updateLocation(normalizedAddress) {
        let addressURL = normalizedAddress.split(" ").join("+");
        let requestURL = "https://maps.googleapis.com/maps/api/geocode/json?address=" + addressURL + "&key=AIzaSyDeataTmSWECGMeGzuh5-RbAadj_rMqbgI";
        
        $.getJSON(requestURL, function (data) {
            if (data["status"] == "OK") {
                let latitude = data["results"][0]["geometry"]["location"]["lat"];
                let longitude = data["results"][0]["geometry"]["location"]["lng"];
                $("#Lat").val(latitude).change();
                $("#Long").val(longitude).change();

                displayLocation(latitude, longitude);
            }
            else
                errorDiv.innerHTML = "Error ocurred while searching your address on map. Please refresh page.";
        });
    }

    function displayError(message) { 
        errorDiv.innerHTML = message;
        errorDiv.style.display = "";
    }

    function hideError() { 
        errorDiv.style.display = "none";
    }

    function navigatorError(error) { 
        switch (error.code) {
            case error.PERMISSION_DENIED:
                displayError("Permission denied by user.");
                break;
            case error.TIMEOUT:
                displayError("Request timed out. Please check your network connection.");
                break;
            case error.UNKNOWN_ERR:
                diplayError("An error has occurred. Please try again.");
                break;
            case error.POSITION_UNAVAILABLE:
                displayError("Location Service was not available. Please make sure GPS is enabled.");
                break;
        }
    }
    
    ko.applyBindings(ViewModel);

    $("document").ready(function () {
        $('.ui.dropdown').dropdown();
    });
</script>