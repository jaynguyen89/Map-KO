<style type="text/css">
    .microBtn {
        padding: 3px !important;
        font-size: 10px !important;
        border-radius: 3px !important;
        margin-top: 2px !important;
    }

    .myTable {
        margin-top: 0px !important;
    }

    .myMap {
        margin-bottom: 20px;
    }

    .setView {
        margin-bottom: 20px;
    }

    #outerDiv {
        position: relative;
    }

    #view_people {
        position: absolute;
        top: 60px;
        left: 30px;
        width: 260px;
    }

    .clearfix { clear: both; }
</style>

<div class="row mainContent">
    <div class="row setView">
        <div class="ui two column centered grid">
            <div class="column">
                <span><b>Select a view mode:</b>&nbsp;</span>
                <select name="View" class="ui dropdown"
                        data-bind="options: VIEWS, value: SelectedView, valueUpdate: 'afterkeydown', event: { change: $root.switchView }">
                </select>
            </div>
        </div>
    </div>

    <div class="ui right labeled input">
        <input type="text" placeholder="Search a person ...">
        <div class="ui dropdown label">
            <div class="text">By Name</div>
            <i class="dropdown icon"></i>
            <div class="menu">
                <div class="item">By Name</div>
                <div class="item">By Email</div>
            </div>
        </div>
    </div>
    
    <div id="outerDiv">
        <div id="main_map" class="ui embed myMap"></div>
        <div class="clearfix"></div>
        <div id="view_people" data-bind="visible: $root.ShouldShowMarkerContent">
            <div class="ui card" data-bind="with: $root.SelectedPeople">
                <div class="content">
                    <div class="header" style="font-size: 16px;" data-bind="text: '#' + Id + ' | ' + FullName()"></div>
                    <div class="meta" style="font-size: 12px;" data-bind="text: Email"></div>
                    <div class="meta" style="font-size: 12px;" data-bind="text: Phone() + ' | ' + Birth()"></div>
                    <div class="description">
                        <i class="fas fa-map-marked-alt"></i>&nbsp;
                        <span style="font-size: 13px;" data-bind="text: NormalizedAddress"></span>
                    </div>
                    <div class="row">
                        <button class="microBtn ui blue button">Select</button>
                        <button class="microBtn ui red button right floated" data-bind="click: $root.deletePeople.bind(this, Id)">Delete</button>
                        <button class="microBtn ui orange button right floated" data-bind="click: $root.editPeople.bind(this, Id)">Edit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <table id="main_table" class="myTable ui compact celled definition blue table" data-bind="with: $root.People">
        <thead class="full-width">
            <tr>
                <th class="center aligned"><i class="fas fa-hand-point-up"></i></th>
                <th class="center aligned"><i class="fas fa-hashtag"></i></th>
                <th class="center aligned"><i class="fas fa-signature"></i> Name</th>
                <th class="center aligned"><i class="fas fa-envelope"></i> Email</th>
                <th class="center aligned"><i class="fas fa-phone"></i> Phone</th>
                <th class="center aligned"><i class="fas fa-birthday-cake"></i> Birthday</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: $root.People">
            <tr data-bind="visible: IsActive">
                <td class="collapsing">
                    <div class="ui fitted slider checkbox">
                        <input id="" type="checkbox"><label></label>
                    </div>
                </td>
                <th data-bind="text: Id"></th>
                <th>
                    <div class="ui stackable two column grid">
                        <div class="column">
                            <span data-bind="text: FullName"></span>
                        </div>
                        <div class="column">
                            <button class="microBtn ui red button right floated" data-bind="click: $root.deletePeople">Delete</button>
                            <button class="microBtn ui orange button right floated" data-bind="click: $root.editPeople">Edit</button>
                            <button class="microBtn ui blue button right floated">Details</button>
                        </div>
                    </div>
                </th>
                <th data-bind="text: Email"></th>
                <th data-bind="text: Phone"></th>
                <th data-bind="text: Birth"></th>
            </tr>
        </tbody>
        <tfoot class="full-width">
            <tr>
                <th></th>
                <th colspan="5">
                    <div class="ui right floated small red icon button">
                        <i class="fas fa-reply"></i> Revert to Default
                    </div>
                    <div class="ui right floated small primary icon button">
                        <i class="fas fa-user-plus"></i> Add People
                    </div>
                    <div class="ui left floated small green icon button">
                        <i class="fas fa-route"></i> Distance
                    </div>
                </th>
            </tr>
        </tfoot>
    </table>
</div>

<script type="text/javascript">
    var infowindow = new google.maps.InfoWindow();
    var marker;

    var data = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "files/model.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })();

    function PeopleModel(people) {
        var self = this;
        self.Id = people.Id;
        self.FamilyName = people.FamilyName ? ko.observable(people.FamilyName) : ko.observable("");
        self.GiveName = people.GiveName ? ko.observable(people.GiveName) : ko.observable("");
        self.FullName = ko.observable("");
        self.Email = people.Email ? ko.observable(people.Email) : ko.observable("Email not given.");
        self.Phone = people.Phone ? ko.observable(people.Phone) : ko.observable("---");
        self.Birth = people.Birth ? ko.observable(people.Birth) : ko.observable("---");
        self.BuildingAddress = people.BuildingAddress ? ko.observable(people.BuildingAddress) : ko.observable("");
        self.StreetAddress = people.StreetAddress ? ko.observable(people.StreetAddress) : ko.observable("");
        self.AlternateAddress = people.AlternateAddress ? ko.observable(people.AlternateAddress) : ko.observable("");
        self.Suburb = people.Suburb ? ko.observable(people.Suburb) : ko.observable("");
        self.Postcode = people.Postcode ? ko.observable(people.Postcode) : ko.observable("");
        self.State = people.State ? ko.observable(people.State) : ko.observable("");
        self.NormalizedAddress = ko.observable("");
        self.Note = people.Note ? ko.observable(people.Note) : ko.observable("");
        self.IsActive = ko.observable(people.IsActive);
    }

    function ViewModel() {
        var self = this;
        self.STATES = ["ACT", "NSW", "NT", "QLD", "SA", "TAS", "VIC", "WA"];
        self.VIEWS = ["Both Views", "Map View", "Table View"];
        self.SelectedView = ko.observable("Both Views");
        
        self.switchView = function () {
            if (self.SelectedView() === "Map View") {
                $("#main_map").show("slow");
                $("#main_table").hide("slow");
            }

            if (self.SelectedView() === "Table View") {
                $("#main_map").hide("slow");
                $("#main_table").show("slow");
            }
            
            if (self.SelectedView() === "Both Views") {
                $("#main_map").show("slow");
                $("#main_table").show("slow");
            }
        }

        self.People = ko.observableArray();
        for (var k in data) {
            var people = new PeopleModel(ko.toJS(data[k]));
            people.FullName = ko.computed(function () {
                let fullName = people.GiveName() + " " + people.FamilyName();
                return fullName;
            });

            people.NormalizedAddress = ko.computed(function () {
                let building = (people.BuildingAddress().length === 0 ? "" : people.BuildingAddress() + ", "); 
                let street = (people.StreetAddress().length === 0 ? "" : people.StreetAddress() + ", "); 
                let suburb = (people.Suburb().length === 0 ? "" : people.Suburb() + ", ");

                if (!building && !street && !suburb)
                return "More information needed.";
            
                return building + street + suburb + people.State() + " " + people.Postcode();
            });

            self.People.push(people);
        }

        self.locations = ko.computed(function () {
            var locs = [];
            ko.utils.arrayForEach(self.People(), function(p) {
                if (p.IsActive()) {
                    let tokens = p.Note().split(",");
                    let lat = tokens.length === 2 ? tokens[0] : 0;
                    let long = tokens.length === 2 ? tokens[1] : 0;

                    var loc = [p.Id, p.FullName, p.Email, p.Phone, p.Birth, parseFloat(lat), parseFloat(long)];
                    locs.push(loc);
                }
            });

            return locs;
        }, self);

        self.ShouldShowMarkerContent = ko.observable(false);
        self.SelectedMarker = ko.observable();
        
        self.getMarkerState = function (marker) {
            self.SelectedMarker(self.People()[marker.title - 1]);
            self.ShouldShowMarkerContent(true);
        }

        renderMap(self.locations, self.getMarkerState, self.ShouldShowMarkerContent);

        self.editPeople = function (peopleId) {
            alert(peopleId);
        }

        self.deletePeople = function (peopleId) {
            if (confirm("Are you sure to delete #" + peopleId + ": " + self.People()[peopleId - 1].FullName() + "?")) { 
                self.People()[peopleId - 1].IsActive(false);
                self.ShouldShowMarkerContent(false);
                renderMap(self.locations, self.getMarkerState, self.ShouldShowMarkerContent);
            }
        }
    }

    var ViewModel = new ViewModel();

    function renderMap(locations, getMarkerState, ShouldShowMarkerContent) {
        var map = new google.maps.Map(document.getElementById('main_map'), {
            zoom: 4.5,
            center: new google.maps.LatLng(-25.656515, 133.245630),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        for (var i = 0; i < locations().length; i++) {
            if (locations()[i][5] === 0 || locations()[i][6] === 0)
                continue;
            
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(locations()[i][5], locations()[i][6]),
                title: locations()[i][0],
                map: map
            });

            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    infowindow.setContent(locations()[i][1]());
                    infowindow.open(map, marker);
                    getMarkerState(this);
                }
            })(marker, i));

            google.maps.event.addListener(infowindow, 'closeclick', function () {
                ShouldShowMarkerContent(false);
            });
        }
    }
    
    ko.applyBindings(ViewModel);

    $("document").ready(function () {
        $('.ui.dropdown').dropdown();
    });
</script>