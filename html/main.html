<script src="//cdn.jsdelivr.net/npm/jquery.scrollto@2.1.2/jquery.scrollTo.min.js"></script>
<style type="text/css">
    .microBtn {
        padding: 3px !important;
        font-size: 10px !important;
        border-radius: 3px !important;
        margin-top: 2px !important;
    }

    .myTable {
        margin-top: 0px !important;
    }

    .myMap {
        margin-bottom: 20px;
    }

    .setView {
        margin-bottom: 20px;
    }

    #outerDiv {
        position: relative;
    }

    #view_people {
        position: absolute;
        top: 60px;
        left: 30px;
        width: 260px;
    }

    #view_pair {
        position: absolute;
        top: 60px;
        left: 30px;
        width: 260px;
    }

    #editPeople {
        width: 100%;
        margin-bottom: 20px;
    }

    #print_distance {
        background-color: #cccccc;
        font-size: 11px;
        line-height: 15px;
        padding: 7px;
        border: gray;
        border-radius: 10px;
    }

    .clearfix { clear: both; }

    [data-tooltip]:after {
        font-size: 12px !important;
        padding: 5px !important;
    }
</style>

<div class="row mainContent">
    <div class="row setView">
        <div class="ui two column centered grid">
            <div class="column">
                <span><b>Select a view mode:</b>&nbsp;</span>
                <select name="View" class="ui dropdown"
                        data-bind="options: VIEWS, value: SelectedView, valueUpdate: 'afterkeydown', event: { change: $root.SwitchView }">
                </select>
            </div>
        </div>
    </div>

    <div class="ui right labeled input">
        <input type="text" placeholder="Search a person ..." data-bind="textInput: $root.Keyword, event: { keyup: $root.ProcessSearch }">
        <select id="searchBy" class="ui dropdown label" data-bind="options: $root.SEARCH, value: SearchBy" />
        <div id="scroll_anchor"></div>
    </div>
    
    <div id="outerDiv">
        <div id="main_map" class="ui embed myMap"></div>
        <div class="clearfix"></div>
        <div id="view_people" data-bind="visible: $root.ShouldShowMarkerContent">
            <div class="ui blue card" data-bind="with: $root.SelectedMarker">
                <div class="content">
                    <div class="header" style="font-size: 16px;" data-bind="text: '#' + Id + '&nbsp;|&nbsp;' + $root.FullNames()[Id - 1]"></div>
                    <div class="meta" style="font-size: 12px;" data-bind="text: Email"></div>
                    <div class="meta" style="font-size: 12px;" 
                         data-bind="text: Phone() + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' + $root.Births()[Id - 1]"></div>
                    <div class="description">
                        <i class="fas fa-map-marked-alt"></i>&nbsp;
                        <span style="font-size: 13px;" data-bind="text: $root.NormalizedAddresses()[Id - 1]"></span>
                    </div>
                    <div class="row">
                        <input class="ui checkbox" type="checkbox" data-bind="checked: IsChosen" data-tooltip="Select this People" data-position="right center">
                        <button class="microBtn ui red button right floated" data-bind="click: $root.DeletePeopleOnMap.bind(this, Id), disable: $root.ShouldDisable">Delete</button>
                        <button class="microBtn ui orange button right floated" data-bind="click: $root.EditPeopleOnMap.bind(this, Id), disable: $root.ShouldDisable">Edit</button>
                    </div>
                </div>
            </div>
            <div class="row" data-bind="visible: $root.ShouldShowCloseDetails">
                <button class="mini ui black button" data-bind="click: $root.CloseDetails">Close Details</button>
            </div>
        </div>
        <div id="view_pair" data-bind="visible: $root.ShouldShowDistance">
            <div class="ui blue card" id="pair_details"></div>
            <p id="print_distance"></p>
            <button id="closeDistance" class="mini ui black button" data-bind="click: $root.CloseDistance">Close Distance</button>
        </div>
    </div>

    <div id="editPeople" class="ui blue card" data-bind="visible: ShouldShowEditPeople">
        <div class="content">
            <div class="header">Edit People</div>
            <div class="description">Please note: the fields with asterisk (*) are required.</div>
        </div>
        <div class="extra content">
            <div class="ui stackable grid">
                <div class="six wide column">
                    <div id="address_map" class="ui embed" style="height: 100%;"></div>
                </div>
                <div class="ten wide column">
                    <form class="ui form" data-bind="with: SelectedPeople">
                        <p id="editPeopleError" style="color: orangered; display: none;">This is an error.</p>
                        <div class="ui stackable grid">
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="FamilyName">Family Name*</label>
                                    <input type="text" name="FamilyName" id="FamilyName" data-bind="value: FamilyName" placeholder="Ex. Potter" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="GiveName">Give Name*</label>
                                    <input type="text" name="GiveName" id="GiveName" data-bind="value: GiveName" placeholder="Ex. Harry" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="Email">Email</label>
                                    <input type="email" name="Email" id="Email" data-bind="value: Email" placeholder="Ex. some.thing_else123@domain.com.ex" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="Phone">Phone</label>
                                    <input type="text" name="Phone" id="Phone" data-bind="value: Phone" placeholder="Ex: 0412 345 678" />
                                </div>
                            </div>
                            <div class="sixteen wide column">
                                <div class="sixteen wide column"><span style="color: black;">Birthday</span></div>
                                <div class="ui stackable grid">
                                    <div class="five wide column">
                                        <label for="Birthday">Day</label>
                                        <input type="number" min="1" max="31" name="Birthday" id="Birthday" data-bind="value: Birthday()" />
                                    </div>
                                    <div class="five wide column">
                                        <label for="Birthmonth">Month</label>
                                        <input type="number" min="1" max="12" name="Birthmonth" id="Birthmonth" data-bind="value: Birthmonth()" />
                                    </div>
                                    <div class="five wide column">
                                        <label for="Birthyear">Year</label>
                                        <input type="number" min="0" name="Birthyear" id="Birthyear" data-bind="value: Birthyear()" />
                                    </div>
                                    <div class="one wide column">
                                        <label for="BC">BC</label>
                                        <input type="checkbox" name="BC" value="1" id="BC" data-bind="checked: BirthBC" />
                                    </div>
                                </div>
                            </div>
                            <div class="sixteen wide column"><b style="color: black;">People Home Address</b></div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="BuildingAddress">Building Address</label>
                                    <input type="text" name="BuildingAddress" id="BuildingAddress" data-bind="value: BuildingAddress" placeholder="Ex: Building 1, Fl4.120" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="StreetAddress">Street Address*</label>
                                    <input type="text" name="StreetAddress" id="StreetAddress" data-bind="value: StreetAddress, event: { change: $root.relocatePeople }" placeholder="Ex: 12 Somewhere Street" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="AlternateAddress">Alternate Address</label>
                                    <input type="text" name="AlternateAddress" id="AlternateAddress" data-bind="value: AlternateAddress" placeholder="optional" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="Suburb">Suburb*</label>
                                    <input type="text" name="Suburb" id="Suburb" data-bind="value: Suburb, event: { change: $root.RelocatePeople }" placeholder="Ex: Sunshine" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="Postcode">Postcode*</label>
                                    <input type="text" name="Postcode" id="Postcode" data-bind="value: Postcode, event: { change: $root.RelocatePeople }" placeholder="Ex: 3020" />
                                </div>
                            </div>
                            <div class="eight wide column">
                                <div class="field">
                                    <label for="State">State*</label>
                                    <select type="text" name="State" id="State" data-bind="options: $root.STATES, value: State, event: { change: $root.RelocatePeople }" />
                                </div>
                            </div>
                            <input type="text" name="Lat" id="Lat" data-bind="value: Lat" hidden />
                            <input type="text" name="Long" id="Long" data-bind="value: Long" hidden />
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="extra content">
            <button class="ui green button" data-bind="click: $root.DetectLocation"><i class="fas fa-map-marker-alt"></i> Auto Detect</button>
            <div class="right floated">
                <button class="ui black button" data-bind="click: $root.CancelEdit"><i class="fas fa-undo"></i> Cancel</button>
                <button class="ui blue button" data-bind="click: $root.EditPeopleConfirmed"><i class="fas fa-check"></i> Done</button>
            </div>
        </div>
    </div>

    <table id="main_table" class="myTable ui compact celled definition blue table" data-bind="with: $root.People">
        <thead class="full-width">
            <tr>
                <th class="center aligned"><i class="fas fa-hand-point-up"></i><br />Select</th>
                <th class="center aligned"><i class="fas fa-hashtag"><br />Id</i></th>
                <th class="center aligned"><i class="fas fa-signature"></i><br />Name</th>
                <th class="center aligned"><i class="fas fa-envelope"></i><br />Email</th>
                <th class="center aligned"><i class="fas fa-phone"></i><br />Phone</th>
                <th class="center aligned"><i class="fas fa-birthday-cake"></i><br />Birthday</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: $root.People">
            <tr data-bind="visible: IsActive">
                <td class="collapsing">
                    <div class="ui fitted slider checkbox">
                        <input type="checkbox" data-bind="checked: IsChosen"><label></label>
                    </div>
                </td>
                <th data-bind="text: Id"></th>
                <th>
                    <div class="ui stackable two column grid">
                        <div class="column">
                            <span data-bind="text: $root.FullNames()[Id - 1]"></span>
                            <p style="color: purple; font-size: 11px;" data-bind="visible: !Long()">(Not in map)</p>
                        </div>
                        <div class="column">
                            <button name="tableDelete" class="microBtn ui red button right floated" data-bind="click: $root.DeletePeople">Delete</button>
                            <button name="tableEdit" class="microBtn ui orange button right floated" data-bind="click: $root.EditPeopleOnTable">Edit</button>
                            <button class="microBtn ui blue button right floated" id="people_details" data-bind="click: $root.ViewDetails">Details</button>
                        </div>
                    </div>
                </th>
                <th data-bind="text: Email"></th>
                <th data-bind="text: Phone"></th>
                <th data-bind="text: $root.Births()[Id - 1]"></th>
            </tr>
        </tbody>
        <tfoot class="full-width">
            <tr>
                <th></th>
                <th colspan="5">
                    <button class="ui right floated small red icon button" data-bind="click: $root.RevertDefault, enable: $root.IsDirty">
                        <i class="fas fa-reply"></i> Revert to Default
                    </button>
                    <div name="addPeople" class="ui right floated small primary icon button" data-bind="click: $root.AddPeople">
                        <i class="fas fa-user-plus"></i> Add People
                    </div>
                    <div class="ui left floated small green icon button" data-bind="click: $root.CalculateDistance"
                         data-tooltip="Select exactly 2 People to calculate distance." data-position="top left">
                        <i class="fas fa-route"></i> Distance
                    </div>
                    <div name="autoDistance" class="ui left floated small violet icon button" data-bind="click: $root.AutoDistance"
                         data-tooltip="Randomly select 2 People then calculate distance" data-position="top left">
                        <i class="fas fa-random"></i> Auto Distance
                    </div>
                </th>
            </tr>
        </tfoot>
    </table>
</div>

<div class="ui small modal" id="addPeopleModal">
    <div class="header">Add People</div>
    <div class="content">
        <form class="ui form" data-bind="with: $root.NewPeople">
            <div class="ui stackable grid">
                <div class="eight wide column">
                    <div class="field">
                        <label for="FamilyName">Family Name*</label>
                        <input type="text" name="FamilyName" id="FamilyName" data-bind="value: FamilyName" placeholder="Ex. Potter" />
                    </div>
                </div>
                <div class="eight wide column">
                    <div class="field">
                        <label for="GiveName">Give Name*</label>
                        <input type="text" name="GiveName" id="GiveName" data-bind="value: GiveName" placeholder="Ex. Harry" />
                    </div>
                </div>
                <div class="eight wide column">
                    <div class="field">
                        <label for="Email">Email</label>
                        <input type="email" name="Email" id="Email" data-bind="value: Email" placeholder="Ex. some.thing_else123@domain.com.ex" />
                    </div>
                </div>
                <div class="eight wide column">
                    <div class="field">
                        <label for="Phone">Phone</label>
                        <input type="text" name="Phone" id="Phone" data-bind="value: Phone" placeholder="Ex: 0412 345 678" />
                    </div>
                </div>
                <div class="sixteen wide column">
                    <div class="sixteen wide column"><span style="color: black;">Birthday</span></div>
                    <div class="ui stackable grid">
                        <div class="five wide column">
                            <label for="Birthday">Day</label>
                            <input type="number" min="1" max="31" name="Birthday" id="Birthday" data-bind="value: Birthday" />
                        </div>
                        <div class="five wide column">
                            <label for="Birthmonth">Month</label>
                            <input type="number" min="1" max="12" name="Birthmonth" id="Birthmonth" data-bind="value: Birthmonth" />
                        </div>
                        <div class="five wide column">
                            <label for="Birthyear">Year</label>
                            <input type="number" min="0" name="Birthyear" id="Birthyear" data-bind="value: Birthyear" />
                        </div>
                        <div class="one wide column">
                            <label for="BC">BC</label>
                            <input type="checkbox" name="BC" value="1" id="BC" data-bind="checked: BirthBC" />
                        </div>
                    </div>
                </div>
                <div class="sixteen wide column">
                    (*) Please use feature "Edit People" to update location.
                </div>
            </div>
        </form>
    </div>
    <div class="actions">
        <button class="ui blue button" data-bind="click: $root.AddPeopleConfirmed"><i class="fas fa-check"></i> Done</button>
    </div>
</div>

<script type="text/javascript">
    var infowindow = new google.maps.InfoWindow();
    var marker;

    var errorDiv = document.getElementById("editPeopleError");

    var data = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "files/model.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })();

    function PeopleModel(people) {
        var self = this;
        self.Id = people.Id;
        self.FamilyName = people.FamilyName ? ko.observable(people.FamilyName) : ko.observable("");
        self.GiveName = people.GiveName ? ko.observable(people.GiveName) : ko.observable("");
        self.Email = people.Email ? ko.observable(people.Email) : ko.observable("Email not given.");
        self.Phone = people.Phone ? ko.observable(people.Phone) : ko.observable("---");
        self.Birthday = people.Birthday ? ko.observable(people.Birthday) : ko.observable("--");
        self.Birthmonth = people.Birthmonth ? ko.observable(people.Birthmonth) : ko.observable("--");
        self.Birthyear = people.Birthyear ? ko.observable(people.Birthyear) : ko.observable("--");
        self.BirthBC = ko.observable(people.BirthBC);
        self.BuildingAddress = people.BuildingAddress ? ko.observable(people.BuildingAddress) : ko.observable("");
        self.StreetAddress = people.StreetAddress ? ko.observable(people.StreetAddress) : ko.observable("");
        self.AlternateAddress = people.AlternateAddress ? ko.observable(people.AlternateAddress) : ko.observable("");
        self.Suburb = people.Suburb ? ko.observable(people.Suburb) : ko.observable("");
        self.Postcode = people.Postcode ? ko.observable(people.Postcode) : ko.observable("");
        self.State = people.State ? ko.observable(people.State) : ko.observable("");
        self.Lat = people.Lat ? ko.observable(people.Lat) : ko.observable("");
        self.Long = people.Long ? ko.observable(people.Long) : ko.observable("");
        self.IsActive = ko.observable(people.IsActive);
        self.IsChosen = ko.observable(false);
    }

    function ViewModel() {
        var self = this;
        self.STATES = ["ACT", "NSW", "NT", "QLD", "SA", "TAS", "VIC", "WA"];
        self.VIEWS = ["Both Views", "Map View", "Table View"];
        self.SEARCH = ["By Name", "By Email"];
        self.IsDirty = ko.observable(false);
        self.SelectedView = ko.observable("Both Views");
        self.ShouldDisable = ko.observable(false);
        self.ShouldShowMarkerContent = ko.observable(false);
        self.SelectedMarker = ko.observable();
        self.ShouldShowEditPeople = ko.observable(false);
        self.SelectedPeople = ko.observable();
        self.TempPeople = null;
        self.ShouldShowCloseDetails = ko.observable(false);
        self.ShouldShowDistance = ko.observable(false);
        self.PeopleBackup = ko.observableArray();
        self.Keyword = ko.observable("");
        self.SearchBy = ko.observable("Name");
        
        self.SwitchView = function () {
            if (self.SelectedView() === "Map View") {
                $("#main_map").show("slow");
                $("#main_table").hide("slow");
                if (self.SelectedMarker() != undefined)
                    self.ShouldShowMarkerContent(true);
            }

            if (self.SelectedView() === "Table View") {
                $("#main_map").hide("slow");
                $("#main_table").show("slow");
                self.ShouldShowMarkerContent(false);
                $("#closeDistance").click();
            }
            
            if (self.SelectedView() === "Both Views") {
                $("#main_map").show("slow");
                $("#main_table").show("slow");
                if (self.SelectedMarker() != undefined)
                    self.ShouldShowMarkerContent(true);
            }
            
            self.ShouldShowEditPeople(false);
            self.SelectedPeople(null);
        }

        self.People = ko.observableArray();
        for (var k in data) {
            var people = new PeopleModel(ko.toJS(data[k]));
            self.People.push(people);
        }

        self.PeopleBackup(self.People());

        self.FullNames = ko.computed(function () {
            var fullNames = [];
            ko.utils.arrayForEach(self.PeopleBackup(), function (p) {
                let fullName = p.GiveName() + " " + p.FamilyName();
                fullNames.push(fullName);
            });
            
            return fullNames;
        }, self);

        self.NormalizedAddresses = ko.computed(function () {
            var normalizedAddresses = [];
            ko.utils.arrayForEach(self.PeopleBackup(), function (p) {
                let building = (p.BuildingAddress().length === 0 ? "" : p.BuildingAddress() + ", "); 
                let street = (p.StreetAddress().length === 0 ? "" : p.StreetAddress() + ", "); 
                let suburb = (p.Suburb().length === 0 ? "" : p.Suburb() + ", ");

                let normalizedAddress = "";
                if (!building && !street && !suburb)
                    normalizedAddress = "Address not available.";
                else
                    normalizedAddress = building + street + suburb + p.State() + " " + p.Postcode();

                normalizedAddresses.push(normalizedAddress);
            });

            return normalizedAddresses;
        }, self);

        self.Births = ko.computed(function () {
            var births = [];
            ko.utils.arrayForEach(self.PeopleBackup(), function (p) {
                let birth = p.Birthday() + "/" + p.Birthmonth() + "/" + p.Birthyear() + (p.BirthBC() ? " BC" : "");
                births.push(birth);
            });

            return births;
        }, self);

        self.locations = ko.computed(function () {
            var locs = [];
            ko.utils.arrayForEach(self.People(), function (p) {
                if (p.IsActive()) {
                    var loc = [p.Id, self.FullNames()[p.Id - 1], p.Email, p.Phone, self.Births()[p.Id - 1], parseFloat(p.Lat()), parseFloat(p.Long())];
                    locs.push(loc);
                }
            });

            return locs;
        }, self);
        
        self.GetMarkerState = function (marker) {
            self.SelectedMarker(self.People()[marker.title - 1]);
            self.ShouldShowMarkerContent(true);
        }

        renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);

        self.CancelEdit = function () {
            self.TempPeople = null;
            self.SelectedPeople(null);
            self.ShouldShowEditPeople(false);
        }
        
        self.EditPeopleOnTable = function (people) {
            self.TempPeople = people;
            self.SelectedPeople(new PeopleModel(ko.toJS(people)));
            renderAddressMap(parseFloat(self.TempPeople.Lat()), parseFloat(self.TempPeople.Long()));
            self.ShouldShowEditPeople(true);
            $.scrollTo("#editPeople", 1000);
        }

        self.EditPeopleOnMap = function (peopleId) {
            self.TempPeople = self.People()[peopleId - 1];
            self.SelectedPeople(new PeopleModel(ko.toJS(self.TempPeople)));
            renderAddressMap(parseFloat(self.TempPeople.Lat()), parseFloat(self.TempPeople.Long()));
            self.ShouldShowEditPeople(true);
            $.scrollTo("#editPeople", 1000);
        }

        self.EditPeopleConfirmed = function () {
            let shouldSave = isEditted(self.TempPeople, self.SelectedPeople);

            if (shouldSave) {
                let edittedPeople = new PeopleModel(ko.toJS(self.SelectedPeople));
                self.People.replace(self.TempPeople, edittedPeople);
                
                renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
                self.ShouldShowMarkerContent(false);
                self.SelectedMarker(null);
                
                self.ShouldShowEditPeople(false);
                self.PeopleBackup(self.People());
                self.IsDirty(true);
                alert("New changes have been saved to people #" + edittedPeople.Id + " | " + self.FullNames()[edittedPeople.Id - 1]);
            }
            else
                alert("No changes has been made. Please click \"Cancel\" button instead.");
        }

        self.DetectLocation = function () {
            if (confirm("Map-KO needs to access your device\'s location service.")) {
                if (navigator.geolocation) {
                    errorDiv.style.display = "none";
                    navigator.geolocation.getCurrentPosition(processPosition, navigatorError);
                }
                else
                    displayError("Oops! A problem occurred while detecting your location.");
            }
            else
                displayError("Oops! You didn\'t grant permission for location access.");
        }
        
        self.DeletePeople = function (people) {
            if (confirm("Are you sure to delete #" + people.Id + ": " + self.FullNames()[people.Id - 1] + "?")) {
                var temp = new PeopleModel(ko.toJS(people));
                people.IsActive(false);
                self.People.replace(temp, people);
                self.ShouldShowMarkerContent(false);
                self.PeopleBackup(self.People());
                self.IsDirty(true);
                renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent);
            }

            if (self.TempPeople !== null && self.TempPeople.Id === people.Id) {
                self.ShouldShowEditPeople(false);
                self.TempPeople = null;
            }

            if (self.TempPeople !== null && self.TempPeople.Id !== people.Id)
                self.ShouldShowMarkerContent(true);
        }

        self.DeletePeopleOnMap = function (peopleId) {
            if (confirm("Are you sure to delete #" + peopleId + ": " + self.FullNames()[peopleId - 1] + "?")) { 
                self.People()[peopleId - 1].IsActive(false);
                self.ShouldShowMarkerContent(false);
                self.PeopleBackup(self.People());
                self.IsDirty(true);
                renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
            }

            if (self.TempPeople !== null && self.TempPeople.Id === people.Id) {
                self.ShouldShowEditPeople(false);
                self.TempPeople = null;
            }

            if (self.TempPeople !== null && self.TempPeople.Id !== people.Id)
                self.ShouldShowMarkerContent(true);
        }

        self.RelocatePeople = function () {
            let edittedPeople = new PeopleModel(ko.toJS(self.SelectedPeople));
            let building = (edittedPeople.BuildingAddress().length === 0 ? "" : edittedPeople.BuildingAddress() + ", "); 
            let street = (edittedPeople.StreetAddress().length === 0 ? "" : edittedPeople.StreetAddress() + ", "); 
            let suburb = (edittedPeople.Suburb().length === 0 ? "" : edittedPeople.Suburb() + ", ");

            let normalizedAddress = building + street + suburb + edittedPeople.State() + " " + edittedPeople.Postcode();
            updateLocation(normalizedAddress);
        }

        self.ViewDetails = function (people) {
            if (people.Lat() && people.Long()) {
                if (self.SelectedView() === "Table View")
                    $("#main_map").show("slow");

                var infoWindow = new google.maps.InfoWindow();
                var map = new google.maps.Map(document.getElementById('main_map'), {
                    zoom: 16,
                    center: new google.maps.LatLng(people.Lat(), people.Long()),
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                });

                var marker = new google.maps.Marker({
                    position: new google.maps.LatLng(people.Lat(), people.Long()),
                    label: { text: self.FullNames()[people.Id - 1], fontWeight: "bold", color: "#FF1493" },
                    icon: {
                        labelOrigin: new google.maps.Point(1, 5),
                        path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                        scale: 5
                    },
                    map: map
                });
            }
            else {
                renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
                alert("#" + people.Id + " | " + self.FullNames()[people.Id - 1] + ": Home address not available. Map not rendered.");
            }

            self.SelectedMarker(new PeopleModel(ko.toJS(people)));
            self.ShouldShowMarkerContent(true);
            self.ShouldShowCloseDetails(true);
            $.scrollTo("#scroll_anchor", 1000);
        }

        self.CloseDetails = function () {
            self.SelectedMarker(null);
            self.ShouldShowMarkerContent(false);
            self.ShouldShowCloseDetails(false);

            renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
        }
        
        self.NewPeople = ko.observable();
        self.AddPeople = function () {
            var people = new PeopleModel({
                                            Id: "",
                                            FamilyName: "",
                                            GiveName: "",
                                            Email: "",
                                            Phone: "",
                                            Birthday: "",
                                            Birthmonth: "",
                                            Birthyear: "",
                                            BirthBC: false,
                                            BuildingAddress: "",
                                            StreetAddress: "",
                                            AlternateAddress: "",
                                            Suburb: "",
                                            Postcode: "",
                                            State: "",
                                            Lat: "",
                                            Long: "",
                                            IsActive: true
                                        });
            people.Id = self.People().length + 1;
            self.NewPeople(ko.toJS(people));
            $("#addPeopleModal").modal("show");
        }

        self.AddPeopleConfirmed = function () {
            var newPeople = new PeopleModel(ko.toJS(self.NewPeople));
            if (newPeople.FamilyName().length === 0 || newPeople.GiveName().length === 0)
                alert("Family Name and Give Name are required.");
            else {
                self.People.push(newPeople);
                self.PeopleBackup(self.People());
                self.IsDirty(true);
                alert("A new people has been added. Please update its location.");
                $('#addPeopleModal').modal("toggle");
            }
        }
        
        self.DistancePair = ko.observableArray();
        self.AutoDistance = function () {
            for (var i = 0; i < self.People().length; i++)
                if (self.People()[i].IsChosen())
                    self.People()[i].IsChosen(false);

            let selectedPair = twoPeopleRandom(self.People().slice());
            self.People()[selectedPair[0].Id - 1].IsChosen(true);
            self.People()[selectedPair[1].Id - 1].IsChosen(true);
            self.DistancePair(selectedPair);

            processDistanceService(selectedPair);

            self.ShouldShowCloseDetails(false);
            self.ShouldShowEditPeople(false);
            self.ShouldShowMarkerContent(false);
            self.ShouldShowDistance(true);
            displayPairOnMap(selectedPair);
            renderDirectionOnMap(selectedPair);
            $.scrollTo("#scroll_anchor", 1000);
        }

        self.CalculateDistance = function () {
            var countSelected = checkSelectedPeople(self.People().slice());
            if (countSelected !== 2)
                showCountWarning(countSelected);
            else {
                let selectedPair = [];
                for (var i = 0; i < self.People().length; i++) {
                    if (self.People()[i].IsChosen())
                        selectedPair.push(self.People()[i]);

                    if (selectedPair.length === 2)
                        break;
                }

                self.DistancePair(selectedPair);

                if (!checkAddressPeople(selectedPair))
                    alert("At least 1 selected People is unallocated. Please update its address.");
                else {
                    processDistanceService(selectedPair);

                    self.ShouldShowCloseDetails(false);
                    self.ShouldShowEditPeople(false);
                    self.ShouldShowMarkerContent(false);
                    self.ShouldShowDistance(true);
                    displayPairOnMap(selectedPair);
                    renderDirectionOnMap(selectedPair);
                    $.scrollTo("#scroll_anchor", 1000);
                }
            }
        }

        self.CloseDistance = function () {
            for (var i = 0; i < self.People().length; i++)
                if (self.People()[i].IsChosen())
                    self.People()[i].IsChosen(false);
            
            self.ShouldShowDistance(false);
            renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
        }

        self.ProcessSearch = function () {
            if (self.Keyword().length === 0) {
                self.People(self.PeopleBackup());
                
                self.ShouldDisable(false);
                $("button[name=tableDelete]").prop("disabled", false);
                $("button[name=tableEdit]").prop("disabled", false);
                $("div[name=addPeople]").removeClass("disabled");
                $("div[name=autoDistance]").removeClass("disabled");

                renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
            }
            else if (self.Keyword() === "@") {
                self.People(self.PeopleBackup());
                renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
                alert("It won't search with email keywords.");

                self.ShouldDisable(true);
                $("button[name=tableDelete]").prop("disabled", true);
                $("button[name=tableEdit]").prop("disabled", true);
                $("div[name=addPeople]").addClass("disabled");
                $("div[name=autoDistance]").addClass("disabled");
            }
            else {
                var searchedPeople = [];
                let keyword = self.Keyword().toLowerCase();

                if (self.SearchBy() === "By Name")
                    for (var i = 0; i < self.PeopleBackup().length; i++) {
                        let fullName = self.PeopleBackup()[i].GiveName() + " " + self.PeopleBackup()[i].FamilyName();
                        if (fullName.toLowerCase().indexOf(keyword) !== -1)
                            searchedPeople.push(self.PeopleBackup()[i]);
                    }
                else
                    for (var i = 0; i < self.PeopleBackup().length; i++) {
                        let email = self.PeopleBackup()[i].Email().toLowerCase();
                        let tokens = email.split("@");
                        
                        if (keyword === "." || keyword === ".c" || keyword === ".co" || keyword === ".com") {
                            if (tokens[0].indexOf(keyword) !== - 1)
                                searchedPeople.push(self.PeopleBackup()[i]);
                        }
                        else {
                            if (email.indexOf(keyword) !== -1)
                                searchedPeople.push(self.PeopleBackup()[i]);
                        }
                    }
                
                if (searchedPeople.length !== 0) {
                    self.People(searchedPeople);
                    renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
                    $.scrollTo("#scroll_anchor", 1000);
                }
                else {
                    self.People([]);
                    alert("No matching people was found. Please try another keyword.");
                }

                self.ShouldDisable(true);
                $("button[name=tableDelete]").prop("disabled", true);
                $("button[name=tableEdit]").prop("disabled", true);
                $("div[name=addPeople]").addClass("disabled");
                $("div[name=autoDistance]").addClass("disabled");
            }
        }

        self.RevertDefault = function () {
            if (confirm("Everything will be set back to original state. Continue?")) {
                self.People([]);
                for (var k in data) {
                    var people = new PeopleModel(ko.toJS(data[k]));
                    self.People.push(people);
                }

                self.PeopleBackup(self.People());
                self.SelectedView = ko.observable("Both Views");
                self.ShouldShowMarkerContent = ko.observable(false);
                self.SelectedMarker = ko.observable();
                self.ShouldShowEditPeople = ko.observable(false);
                self.SelectedPeople = ko.observable();
                self.TempPeople = null;
                self.ShouldShowCloseDetails = ko.observable(false);
                self.ShouldShowDistance = ko.observable(false);
                self.IsDirty(false);
                renderMap(self.locations, self.GetMarkerState, self.ShouldShowMarkerContent, self.SelectedMarker);
            }
        }
    }

    function renderMap(locations, GetMarkerState, ShouldShowMarkerContent, SelectedMarker) {
        var map = new google.maps.Map(document.getElementById('main_map'), {
            zoom: 4.5,
            center: new google.maps.LatLng(-25.656515, 133.245630),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        for (var i = 0; i < locations().length; i++) {
            if (locations()[i][5] === 0 || locations()[i][6] === 0)
                continue;
            
            marker = new google.maps.Marker({
                position: new google.maps.LatLng(locations()[i][5], locations()[i][6]),
                title: locations()[i][0],
                map: map
            });

            google.maps.event.addListener(marker, 'click', (function(marker, i) {
                return function() {
                    infowindow.setContent(locations()[i][1]);
                    infowindow.open(map, marker);
                    GetMarkerState(this);
                }
            })(marker, i));

            google.maps.event.addListener(infowindow, 'closeclick', function () {
                ShouldShowMarkerContent(false);
                SelectedMarker("");
            });
        }
    }

    var addressMap;
    var addressMarker;
    function renderAddressMap(latitude, longitude) {
        if (latitude && longitude) {
            addressMap = new google.maps.Map(document.getElementById('address_map'), {
                zoom: 16,
                center: new google.maps.LatLng(latitude, longitude),
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            addressMarker = new google.maps.Marker({
                position: { lat: latitude, lng: longitude }
            });

            addressMarker.setMap(addressMap);
        }
        else
            addressMap = new google.maps.Map(document.getElementById('address_map'), {
                zoom: 5,
                center: new google.maps.LatLng(-25.656515, 133.245630),
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });
    }

    function processPosition(position) {
        displayLocation(position.coords.latitude, position.coords.longitude);

        $("#Lat").val(position.coords.latitude).change(); 
        $("#Long").val(position.coords.longitude).change();

        let requestURL = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + position.coords.latitude + "," + position.coords.longitude + "&key=AIzaSyDeataTmSWECGMeGzuh5-RbAadj_rMqbgI";
        $.getJSON(requestURL, function (data) {
            if (data["status"] == "OK") {
                $("#StreetAddress").val(data["results"][0]["address_components"][0]["short_name"] + " " + data["results"][0]["address_components"][1]["short_name"]).change();
                $("#Suburb").val(data["results"][0]["address_components"][2]["short_name"]).change();
                $("#Postcode").val(data["results"][0]["address_components"][6]["short_name"]).change();
                $("#State").val(data["results"][0]["address_components"][4]["short_name"]).change();
            }
            else
                errorDiv.innerHTML = "Error ocurred while detecting address. Please try again.";
        });
    }

    function displayLocation(lat, long) { 
        var map = new google.maps.Map(document.getElementById('address_map'), {
            zoom: 16,
            center: new google.maps.LatLng(lat, long),
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat, long),
            label: { text: "Your Location.", fontWeight: "bold", color: "#FF1493" },
            icon: {
                labelOrigin: new google.maps.Point(1, 5),
                path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                scale: 5
            },
            map: map
        });
    }

    function updateLocation(normalizedAddress) {
        let addressURL = normalizedAddress.split(" ").join("+");
        let requestURL = "https://maps.googleapis.com/maps/api/geocode/json?address=" + addressURL + "&key=AIzaSyDeataTmSWECGMeGzuh5-RbAadj_rMqbgI";
        
        $.getJSON(requestURL, function (data) {
            if (data["status"] == "OK") {
                let latitude = data["results"][0]["geometry"]["location"]["lat"];
                let longitude = data["results"][0]["geometry"]["location"]["lng"];
                $("#Lat").val(latitude).change();
                $("#Long").val(longitude).change();

                displayLocation(latitude, longitude);
            }
            else
                errorDiv.innerHTML = "Error ocurred while searching your address on map. Please refresh page.";
        });
    }

    function displayError(message) { 
        errorDiv.innerHTML = message;
        errorDiv.style.display = "";
    }

    function hideError() { 
        errorDiv.style.display = "none";
    }

    function checkSelectedPeople(people) {
        var countSelected = 0;
        for (var i = 0; i < people.length; i++) {
            if (people[i].IsChosen())
                countSelected++;
        }

        return countSelected;
    }

    function showCountWarning(count) {
        if (count == 0)
            alert("No people has been selected. Please select exactly 2 people.");
        else if (count == 1)
            alert("Only 1 people has been selected. Please select exactly 1 more.");
        else
            alert("More than 2 people have been selected. Please only select exactly 2.");
    }

    function checkAddressPeople(people) {
        if (people[0].Lat().length !== 0 && people[1].Lat().length !== 0 &&
            people[0].Long().length !== 0 && people[1].Long().length !== 0)
            return true;
        
        return false;
    }

    function twoPeopleRandom(people) {
        for (var i = 0; i < people.length; i++)
            if (people[i].Lat().length === 0 || people[i].Long().length === 0)
                people.splice(i, 1);

        var currentIndex = people.length, temp, randomIndex;

        while (currentIndex !== 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            temp = people[currentIndex];
            people[currentIndex] = people[randomIndex];
            people[randomIndex] = temp;
        }

        return [people[0], people[1]];
    }

    function processDistanceService(pair) {
        var address1, address2;
        var requestURL1 = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + pair[0].Lat() + "," + pair[0].Long() + "&key=AIzaSyDeataTmSWECGMeGzuh5-RbAadj_rMqbgI";
        var requestURL2 = "https://maps.googleapis.com/maps/api/geocode/json?latlng=" + pair[1].Lat() + "," + pair[1].Long() + "&key=AIzaSyDeataTmSWECGMeGzuh5-RbAadj_rMqbgI";

        $.getJSON(requestURL1, function (data) {
            if (data["status"] == "OK") {
                address1 = data["results"][0]["formatted_address"];

                $.getJSON(requestURL2, function (data) {
                    if (data["status"] == "OK") {
                        address2 = data["results"][0]["formatted_address"];

                        var service = new google.maps.DistanceMatrixService();
                        service.getDistanceMatrix(
                            {
                                origins: [address1],
                                destinations: [address2],
                                travelMode: google.maps.TravelMode.DRIVING,
                                unitSystem: google.maps.UnitSystem.METRIC,
                                avoidHighways: false,
                                avoidTolls: true
                            }, printDistance);
                    }
                    else
                        alert("Oops... Directions not processed successfully. Please try again.");
                });
            }
            else
                alert("Oops... Errors while processing distance. Please try again.");
        });
    }

    var distance, time;
    function printDistance(response, status) {
        if (status != google.maps.DistanceMatrixStatus.OK)
            alert("Oops... Errors while processing distance. Please try again.");
        else {
            if (response.rows[0].elements[0].status === "ZERO_RESULTS")
                alert("Google detects no possible directions between these 2 People. No estimate distance can be advised. Please select another pair.");
            else {
                distance = response.rows[0].elements[0].distance.text;
                time = response.rows[0].elements[0].duration.text;
                
                var content = 'Estimated distance: ' + distance + ', travelling in ' + time + ' by car. Tollway avoided.';
                $("#print_distance").html(content);
            }
        }
    }

    function displayPairOnMap(pair) {
        let building1 = (pair[0].BuildingAddress().length === 0 ? "" : pair[0].BuildingAddress() + ", "); 
        let street1 = (pair[0].StreetAddress().length === 0 ? "" : pair[0].StreetAddress() + ", "); 
        let suburb1 = (pair[0].Suburb().length === 0 ? "" : pair[0].Suburb() + ", ");

        let building2 = (pair[1].BuildingAddress().length === 0 ? "" : pair[1].BuildingAddress() + ", "); 
        let street2 = (pair[1].StreetAddress().length === 0 ? "" : pair[1].StreetAddress() + ", "); 
        let suburb2 = (pair[1].Suburb().length === 0 ? "" : pair[1].Suburb() + ", ");

        var content = '<div class="content"><div class="header" style="font-size: 14px; line-height: 5px;">Distance between:</div></div>' +
            '<div class="extra content" style="color: black; font-size: 12px !important;">' +
                '<p>#' + pair[0].Id + ' | ' + pair[0].GiveName() + ' ' + pair[0].FamilyName() + '</p>' +
                '<p>' + building1 + street1 + suburb1 + pair[0].State() + ' ' + pair[0].Postcode() + '</p>' +
            '</div>' +
            '<div class="extra content" style="color: black; font-size: 12px !important;">' +
                '<p>#' + pair[1].Id + ' | ' + pair[1].GiveName() + ' ' + pair[1].FamilyName() + '</p>' +
                '<p>' + building2 + street2 + suburb2 + pair[1].State() + ' ' + pair[1].Postcode() + '</p>' +
            '</div>';

        $("#pair_details").html(content);
    }

    function renderDirectionOnMap(pair) {
        var stepMarkerArray = [];

        let cenlat = (parseFloat(pair[0].Lat()) + parseFloat(pair[1].Lat()))/2.0;
        let cenlong = (parseFloat(pair[0].Long()) + parseFloat(pair[1].Long()))/2.0;

        var map = new google.maps.Map(document.getElementById('main_map'), {
          zoom: 5,
          center: { lat: cenlat, lng: cenlong }
        });
        
        var stepDisplay = new google.maps.InfoWindow;
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer({map: map});

        let street1 = (pair[0].StreetAddress().length === 0 ? "" : pair[0].StreetAddress() + ", "); 
        let suburb1 = (pair[0].Suburb().length === 0 ? "" : pair[0].Suburb() + ", ");

        let street2 = (pair[1].StreetAddress().length === 0 ? "" : pair[1].StreetAddress() + ", "); 
        let suburb2 = (pair[1].Suburb().length === 0 ? "" : pair[1].Suburb() + ", ");

        directionsService.route({
            origin: street1 + suburb1 + pair[0].State() + ' ' + pair[0].Postcode(),
            destination: street2 + suburb2 + pair[1].State() + ' ' + pair[1].Postcode(),
            travelMode: google.maps.TravelMode.DRIVING
        }, function(response, status) {
            if (status === 'OK') {
                directionsDisplay.setDirections(response);
                showSteps(response, stepMarkerArray, stepDisplay, map);
            }
            else
                alert('Directions request failed due to ' + status);
        });
    }

    function showSteps(directionResult, markerArray, stepDisplay, map) {
        var myRoute = directionResult.routes[0].legs[0];

        for (var i = 0; i < myRoute.steps.length; i++) {
            var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
            marker.setMap(map);
            marker.setPosition(myRoute.steps[i].start_location);

            attachInstructionText(stepDisplay, marker, myRoute.steps[i].instructions, map);
        }
    }

    function attachInstructionText(stepDisplay, marker, text, map) {
        google.maps.event.addListener(marker, 'click', function() {
            stepDisplay.setContent(text);
            stepDisplay.open(map, marker);
        });
    }

    function isEditted(older, newer) {
        let editted = new PeopleModel(ko.toJS(newer));

        if (older.FamilyName() !== editted.FamilyName() || older.GiveName() !== editted.GiveName() ||
            older.Email() !== editted.Email() || older.Phone() !== editted.Phone() ||
            older.Birthday() !== editted.Birthday() || older.Birthmonth() !== editted.Birthmonth() ||
            older.Birthyear() !== editted.Birthyear() || older.BirthBC() !== editted.BirthBC() ||
            older.BuildingAddress() !== editted.BuildingAddress() || older.StreetAddress() !== editted.StreetAddress() ||
            older.AlternateAddress() !== editted.AlternateAddress() || older.Suburb() !== editted.Suburb() ||
            older.Postcode() !== editted.Postcode() || older.State() !== editted.State())
            return true;
        
        return false;
    }

    function navigatorError(error) { 
        switch (error.code) {
            case error.PERMISSION_DENIED:
                displayError("Permission denied by user.");
                break;
            case error.TIMEOUT:
                displayError("Request timed out. Please check your network connection.");
                break;
            case error.UNKNOWN_ERR:
                diplayError("An error has occurred. Please try again.");
                break;
            case error.POSITION_UNAVAILABLE:
                displayError("Location Service was not available. Please make sure GPS is enabled.");
                break;
        }
    }
    
    ko.applyBindings(new ViewModel());

    $("document").ready(function () {
        $('.ui.dropdown').dropdown();
    });
</script>